# هدف المشروع: التحكم في عمولة بوكينج

هذا المستند يربط **هدف المشروع** (مراجعة عمولة بوكينج) مع **المنطق الحالي** والواجهة.

---

## 1. الهدف من المشروع (كما شرحه المالك)

- **بوكينج.كوم** يطلب عمولة عن كل حجز **حضر فعلاً** (ضيف سجّل دخول).
- المستخدم يخرج **كشف إكسيل من نزيل** (برنامج التسكين) ويستخدم المشروع لمقارنة هذا الكشف مع بيانات بوكينج.
- النتائج المطلوبة:
  1. **التأكد أن كل نزلاء بوكينج الذين حضروا** موجودون في نزيل ومدفوعاتهم واضحة (دفعوا في نزيل ≥ المبلغ في بوكينج) — لدفع العمولة وأنت متأكد من الرقم.
  2. **اكتشاف من دفع في نزيل أقل** من بوكينج — لمعرفة أنك ستدفع عمولة على مبلغ معين وربما تحتاج متابعة أو تسوية.
  3. **اكتشاف من لم يحضر (No-show)** — حجز مؤكد في بوكينج لكنه غير موجود في نزيل (لم يسجّل دخول) حتى **لا تدفع عمولة بلا فائدة** على من لم يحضر.

---

## 2. ربط الحالات الحالية بهدف العمولة

| الحالة في النظام | المعنى للمشروع | بالنسبة للعمولة |
|------------------|----------------|------------------|
| **مطابق** (ref, name, alias) | حضر ووُجد في نزيل بمطابقة واضحة (مرجع / اسم / ذاكرة) | ✅ عمولة مستحقة — تحقق من الفرق إن كان نزيل أقل |
| **تجميع/يدوي** (group) | أكثر من حجز بوكينج لنفس الاسم → إقامة واحدة في نزيل | ✅ عمولة مستحقة |
| **بصمة/تمديد** (guess, extension, money) | حضر ووُجد في نزيل بمطابقة أضعف (تخمين، تمديد إقامة) | ✅ عمولة مستحقة |
| **تسكين (إلغاء)** (conflict) | الحالة في بوكينج = ملغي | ❌ لا عمولة |
| **مفقود** (miss) | حجز مؤكد في بوكينج لكن **لم يُوجد له مطابق في نزيل** = لم يحضر | ❌ لا عمولة — راجع القائمة ولا تدفع عمولة على هذه |

---

## 3. الإحصائيات الحالية وربطها بالعمولة

| KPI في الواجهة | المعنى | للعمولة |
|-----------------|--------|---------|
| **إجمالي** (kpiBook) | عدد صفوف بوكينج في الملف | إجمالي الحجوزات |
| **مؤكد / ملغي / NoShow** (subOk, subCan, subNos) | توزيع الحالة في ملف بوكينج | ملغي = لا عمولة؛ NoShow في الملف = حالة أخرى |
| **مطابق** (kpiOk) | مرجع + اسم + ذاكرة + تجميع | عدد حجوزات "واضحة المطابقة" — عمولة مستحقة |
| **بصمة/تمديد** (kpiMoney) | تخمين + تمديد | عمولة مستحقة (بمراجعة) |
| **لم يحضر** (kpiMiss) — يُضاف في الواجهة | مؤكد في بوكينج ولا يوجد له في نزيل | **لا عمولة** — هذا العدد يجب مراجعته قبل دفع العمولة |
| **تسكين (إلغاء)** (kpiRecover) | مطابق لكن الحالة ملغية في بوكينج | لا عمولة |
| **إيراد بوكينج / إيراد نزيل / الفرق** | مقارنة مالية | فرق سالب = دفعت في نزيل أقل من بوكينج — تدفع عمولة على أساس بوكينج |

---

## 4. ما يوفره المشروع حالياً (مراجعة)

- ✅ **وحدة الحجز = رقم الحجز:** تجميع صفوف البوكينج عند الإدخال حسب رقم الحجز (حجز واحد بعدة ضيوف في الإكسيل → صف واحد في التحليل). عدد الحجوزات والإحصائيات تعكس **عدد الحجوزات الفريدة** وليس عدد صفوف الملف.
- ✅ مطابقة بوكينج مع نزيل (مرجع، اسم، تجميع، تمديد، تخمين).
- ✅ تمييز "مطابق" عن "مفقود" (لم يظهر في نزيل = لم يحضر).
- ✅ تمييز "تسكين" (ملغي) عن المؤكد.
- ✅ عرض الفرق (إيراد بوكينج − نزيل) لمعرفة من دفع أقل في نزيل.
- ✅ فلتر "مفقود" لعرض من لم يحضر فقط.
- ✅ عرض عدد "لم يحضر" (kpiMiss) في لوحة KPIs.
- ✅ عرض مجمّع: صف واحد لكل حجز مع دمج أسماء الضيوف وشارة "(ن ضيوف)" عند التعدد.

---

## 5. توصيات الاستخدام لهدف العمولة

1. بعد التحليل، راجع **مفقود** — هؤلاء لا يظهرون في نزيل فلا تدفع عمولة عليهم (إلا إن كان هناك خطأ في المطابقة أو التأخير في التسكين). استخدم فلتر "لم يحضر (لا عمولة)" لعرضهم فقط.
2. راجع **الفرق** السالب — حجوزات دفعت في نزيل أقل من بوكينج؛ ستُحاسب عمولة على أساس بوكينج فتحقق من التسوية.
3. **تسكين (إلغاء)** — لا عمولة؛ يمكن تجاهلها في حساب العمولة.
4. **للتحقق السريع:** افتح الصفحة مع `?loadSample=1` لتحميل ملفات المشروع تلقائياً وتشغيل التحليل دون رفع يدوي.
5. **تقرير تشخيص من البيانات الفعلية:** أضف `&diagnose=1` (مثلاً `?loadSample=1&diagnose=1`) لظهور تقرير تحت الفلاتر يعرض **كل "لم يحضر"** مع **كل مرشحي نزيل** (نفس الكلمات / فرعي / تطابق كلمات) وفرق السعر وفرق الأيام — لرصد الثغرات وتحسين المنطق.

---

## 6. مراجعة نهائية (بناءً على هدف المشروع)

| البند | الهدف | ما تم |
|-------|--------|--------|
| **وحدة الحجز** | حجز واحد = رقم حجز واحد؛ لا تكرار لنفس الحجز في التحليل أو العرض. | تطبيع عند الإدخال (`normalizeBookingByRef`) + تجميع عند العرض حسب رقم الحجز؛ الإحصائيات = عدد الحجوزات الفريدة. |
| **تجربة المستخدم** | وضوح: صف واحد لكل حجز، أسماء الضيوف مدمجة، إشارة (ن ضيوف). | ✅ |
| **الإحصائيات** | عدد الحجوزات = عدد الحجوزات الفريدة؛ "لم يحضر" = حجوزات مؤكدة بدون مطابق في نزيل. | ✅ بعد التطبيع. |
| **ثغرات معروفة** | انظر `GAPS_AND_EDGE_CASES.md` (عناوين، أول مطابقة تأخذ النزيل، بوكينج بدون تاريخ، إلخ). | موثّق؛ يُنصح بمراجعة الملفات قبل الرفع. |

---

تم توثيق هذا الربط في: `COMPARISON_PAGE_LOGIC.md` (قسم الهدف) و `PROJECT_GOAL_COMMISSION.md`.
