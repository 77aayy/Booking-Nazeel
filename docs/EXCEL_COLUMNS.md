# هدف المشروع وأعمدة الإكسل المطلوبة

## الهدف (لم يحضر = لا عمولة)

- **الهدف:** معرفة **من لم يحضر فعلاً** حتى لا تدفع عمولة بوكينج على من لم يسجّل دخول في نزيل.
- **لم يحضر** في النظام = حجز **مؤكد** في بوكينج لكن **لم يُعثَر له على مطابق** في ملف نزيل (لم يُربط بأي صف في الإكسل المُصدّر من نزيل).
- إذا كان "لم يحضر" كثيراً رغم أن النزيل موجود في الملف، فالسبب غالباً أحد اثنين:
  1. **أعمدة الإكسل:** أسماء الأعمدة في الملف تختلف عما يتوقعه النظام (إملاء، مسافات، تعريب) فيُقرأ الملف ناقصاً أو خاطئاً.
  2. **منطق المطابقة:** الاسم أو التاريخ أو السعر مختلف بين الملفين فلم تُحقَّق المطابقة (يُحسَّن عبر مرادفات الأسماء وتوسيع التسامح).

لذلك يجب التأكد من أن **ملف الإكسل يوفّر الأعمدة الصحيحة** وأن **أسماء الأعمدة مطابقة أو مدعومة** كما هو موضّح أدناه.

---

## ملف نزيل (الإكسل المُصدّر من برنامج التسكين نزيل)

### أعمدة مطلوبة (يجب أن يظهر اسمها في صف العناوين)

| المفتاح في الكود | معنى العمود | بدائل مقبولة (إن وُجدت في الكود) |
|-------------------|-------------|-----------------------------------|
| **إسم العميل** | اسم النزيل | `اسم العميل` (بدون همزة) |
| **تاريخ الدخول** | تاريخ دخول النزيل | — |
| **تاريخ الخروج** | تاريخ خروج النزيل | — |
| **الايجار الكلي** أو **الاجمالي** | المبلغ الإجمالي في نزيل | يُقرأ أحدهما؛ إن وُجد الاثنان يُفضّل الأول ثم الثاني |

### عمود اختياري (للمطابقة برقم الحجز — أولوية كبيرة)

- **مرجع** أو **مصدر** أو **رقم الحجز** أو **id** — إن وُجد أحدها في ملف نزيل يُستخدم لمطابقة رقم حجز بوكينج مع نزيل.
- **أولوية كبيرة:** إذا كان نفس رقم الحجز (مثل 5667545212) موجوداً في بوكينج ونزيل، تتم المطابقة **مباشرة** دون التحقق من الاسم. المطابقة بالاسم تبقى خطوة إضافية عندما الموظف نسي كتابة رقم الحجز في نزيل.

### ملاحظات

- صف العناوين يُكتشف في **أول 20 سطراً**؛ إذا كان عنوان الجدول أعلى من ذلك قد لا يُقرأ الملف.
- إذا غيّر برنامج نزيل اسم عمود (مثلاً "اسم العميل" بدل "إسم العميل") يجب إما تصحيح التصدير أو إضافة البديل في الكود (تم إضافة بديل "اسم العميل" → "إسم العميل").

---

## ملف بوكينج (الإكسل المُصدّر من بوكينج أو الرابط معه)

### أعمدة مطلوبة (يجب أن يظهر اسمها في صف العناوين)

| المفتاح في الكود | معنى العمود | بدائل مقبولة |
|-------------------|-------------|---------------|
| **رقم الحجز** | رقم الحجز في بوكينج | — |
| **السعر** | سعر الحجز | — |
| **اسم الضيف** أو **اسم الضيف\\الضيوف** أو **تم الحجز من قِبل** | اسم الضيف | الكود يقرأ أول مفتاح موجود من الثلاثة |
| **الحالة** | مؤكد / ملغي | — |
| **تسجيل الوصول** | تاريخ الوصول | — |
| **تاريخ المغادرة** | تاريخ المغادرة | — |

### ملاحظات

- **اكتشاف الملف:** يجب أن يظهر في نفس الصف عنوانان: **رقم الحجز** و **السعر**؛ إن غاب أحدهما (أو اختلفت الكتابة) لا يُعتبر الملف بوكينج ويُرجع مصفوفة فارغة.
- البوكينج يُصفَّى حسب نطاق تواريخ نزيل: يُحسب من "تاريخ الدخول" في نزيل نطاق (من–إلى) ويُبقى من بوكينج فقط الحجوزات التي "تسجيل الوصول" فيها داخل هذا النطاق (أو بدون تاريخ).

---

## ما الذي يحدث إن نقص عمود؟

- **نزيل:** إن لم يُوجد عمود "إسم العميل" (أو "اسم العميل") → لا يُكتشف صف العناوين → مصفوفة نزيل فارغة → **كل حجوزات بوكينج تظهر "لم يحضر"** حتى لو النزيل موجود في الملف.
- **نزيل:** إن وُجد "إسم العميل" لكن أسماء أعمدة **تاريخ الدخول** أو **الايجار الكلي**/**الاجمالي** مختلفة عن المستخدم في الكود → القيم تُقرأ `undefined` → المطابقة بالسعر والتاريخ تفشل → احتمال كبير أن يُعتبر "لم يحضر".
- **بوكينج:** إن لم يُوجد "رقم الحجز" أو "السعر" في نفس السطر → لا يُعتبر الملف بوكينج → مصفوفة فارغة.

---

## توصية

1. **قبل الرفع:** تأكد أن صف العناوين في كل ملف يحتوي على الأسماء كما في الجدولين أعلاه (أو البدائل المدعومة).
2. **إن غيّر نزيل/بوكينج أسماء الأعمدة:** أضف البديل في الكود (تطبيع أسماء العناوين) كما في `getData` و`normalizeHeader` حتى يُقرأ العمود بالمفتاح الصحيح.
3. **بعد الرفع:** راجع قائمة "لم يحضر"؛ إن وجدت أسماءً تعرف أنهم في نزيل، استخدم "ربما مطابق" و"دمج يدوي" ثم راجع مع مرور الوقت إن كانت هناك أنماط (مثلاً تهجئة معيّنة) لتوسيع منطق المطابقة أو أعمدة إضافية.

---

## قاعدة مرادفات الأسماء (عربي ↔ لاتيني)

**القاعدة:** أمثلة المستخدم (مثل غفران الحسني ↔ Ghufran Mohammed hussein، SAUD ABDULMALIK ↔ سعود عبد الملك) تُستخدم **لتعديل القاعدة** وليس لحل الاسم فقط.

- إضافة مرادف واحد في `COMMON_NAME_EQUIVALENTS` (في الكود) يغطي **كل ضيف** في أي ملف له نفس النمط.
- المطابقة تعمل في **الاتجاهين**: بوكينج عربي ونزيل إنجليزي، أو بوكينج إنجليزي ونزيل عربي.
- عند إرسال مثال جديد: أضف المقابل العربي واللاتيني كمرادف في القائمة؛ النظام يطبّقه تلقائياً على كل الملفات.
- **عكس ترتيب الاسم:** إذا الاسم في نزيل معكوس (أول↔ثاني) مثل **البراء مشبب** مقابل **مشبب البراء** في بوكينج، النظام يطابقه تلقائياً (مرحلة "نفس الكلمات/عكس" وتطابق صارم أول/آخر — نوع الربط: ✨ اسم أو اسم عكس).

تم توثيق هذا في: `PROJECT_GOAL_COMMISSION.md` و `GAPS_AND_EDGE_CASES.md`.
